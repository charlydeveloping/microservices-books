version: "3.9"

services:
  catalog1:
    build: ./catalog-service
    container_name: catalog1
    environment:
      - PORT=3000
      - SEED_BOOKS=true
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_CLIENT_ID=catalog-service
      - KAFKA_GROUP_ID=catalog-group
      - KAFKA_TOPIC_SALES=sales-events
      - DATABASE_URL=postgres://catalog:catalog@catalog-db:5432/catalogdb
    expose:
      - "3000"
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:3000/books"]
    #   interval: 5s
    #   timeout: 3s
    #   retries: 5
    restart: always
    depends_on:
      - kafka

  catalog2:
    build: ./catalog-service
    container_name: catalog2
    environment:
      - PORT=3000
      - SEED_BOOKS=true
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_CLIENT_ID=catalog-service
      - KAFKA_GROUP_ID=catalog-group
      - KAFKA_TOPIC_SALES=sales-events
      - DATABASE_URL=postgres://catalog:catalog@catalog-db:5432/catalogdb
    expose:
      - "3000"
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:3000/books"]
    #   interval: 5s
    #   timeout: 3s
    #   retries: 5
    restart: always
    depends_on:
      - kafka

  load-balancer:
    image: nginx:alpine
    container_name: load-balancer
    ports:
      - "3000:3000"
    volumes:
      - ./load-balancer/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    # depends_on:
    #   catalog1:
    #     condition: service_healthy
    #   catalog2:
    #     condition: service_healthy
    restart: always

  sales-service:
    build: ./sales-service
    container_name: sales-service
    environment:
      - PORT=4000
      - CATALOG_BASE_URL=http://load-balancer:3000
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_CLIENT_ID=sales-service
      - KAFKA_TOPIC_SALES=sales-events
      - DATABASE_URL=postgres://sales:sales@sales-db:5432/salesdb
    ports:
      - "4000:4000"
    depends_on:
      - load-balancer
      - kafka
      - catalog-db
      - sales-db
    restart: always

  zookeeper:
    image: wurstmeister/zookeeper
    container_name: zookeeper
    ports:
      - "2181:2181"

  kafka:
    image: wurstmeister/kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_CREATE_TOPICS: "sales-events:1:1"
    depends_on:
      - zookeeper

  catalog-db:
    image: postgres:16-alpine
    container_name: catalog-db
    environment:
      POSTGRES_DB: catalogdb
      POSTGRES_USER: catalog
      POSTGRES_PASSWORD: catalog
    ports:
      - "5433:5432"
    volumes:
      - catalog-db-data:/var/lib/postgresql/data

  sales-db:
    image: postgres:16-alpine
    container_name: sales-db
    environment:
      POSTGRES_DB: salesdb
      POSTGRES_USER: sales
      POSTGRES_PASSWORD: sales
    ports:
      - "5434:5432"
    volumes:
      - sales-db-data:/var/lib/postgresql/data

networks:
  default:
    name: microservices-books-net

volumes:
  catalog-db-data:
  sales-db-data:
